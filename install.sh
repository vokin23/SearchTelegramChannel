#!/bin/bash

# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Telegram Channel Search Bot
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: curl -sSL https://raw.githubusercontent.com/vokin23/SearchTelegramChannel/main/install.sh | bash

set -e

echo "ðŸš€ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Telegram Channel Search Bot"
echo "=================================================="

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° root
if [ "$EUID" -ne 0 ]; then
    echo "âŒ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ root Ð¸Ð»Ð¸ Ñ sudo"
    exit 1
fi

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÑŽ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ..."
apt update && apt upgrade -y

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
apt install -y python3 python3-pip python3-venv git nano screen curl

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð° (Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ)
echo "ðŸ‘¤ Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°..."
if ! id "telegrambot" &>/dev/null; then
    useradd -r -s /bin/false -d /opt/telegram-bot telegrambot
fi

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
if [ -d "/opt/telegram-bot" ]; then
    echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÑŽ ÑÑ‚Ð°Ñ€ÑƒÑŽ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ..."
    systemctl stop telegram-bot 2>/dev/null || true
    rm -rf /opt/telegram-bot
fi

# ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
echo "ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÑŽ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹..."
git clone https://github.com/vokin23/SearchTelegramChannel.git /opt/telegram-bot
cd /opt/telegram-bot

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
echo "ðŸ Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
python3 -m venv venv
source venv/bin/activate

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Python
echo "ðŸ“‹ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Python..."
pip install --upgrade pip
pip install -r requirements.txt

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð¸Ð· Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð°
echo "âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ñ„Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
if [ ! -f ".env" ]; then
    cp .env.example .env
    echo "ðŸ“ Ð¤Ð°Ð¹Ð» .env ÑÐ¾Ð·Ð´Ð°Ð½. ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒÑ‚Ðµ ÐµÐ³Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ!"
fi

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
echo "ðŸ”’ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÑŽ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°..."
chown -R telegrambot:telegrambot /opt/telegram-bot
chmod +x /opt/telegram-bot/venv/bin/python

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ
echo "âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°ÑŽ systemd ÑÐµÑ€Ð²Ð¸Ñ..."
cat > /etc/systemd/system/telegram-bot.service << 'EOF'
[Unit]
Description=Telegram Channel Search Bot
After=network.target

[Service]
Type=simple
User=telegrambot
Group=telegrambot
WorkingDirectory=/opt/telegram-bot
Environment=PATH=/opt/telegram-bot/venv/bin
ExecStart=/opt/telegram-bot/venv/bin/python bot.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ systemd
systemctl daemon-reload

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÑŽ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ..."
cat > /usr/local/bin/telegram-bot << 'EOF'
#!/bin/bash
case "$1" in
    start)
        systemctl start telegram-bot
        ;;
    stop)
        systemctl stop telegram-bot
        ;;
    restart)
        systemctl restart telegram-bot
        ;;
    status)
        systemctl status telegram-bot
        ;;
    logs)
        journalctl -u telegram-bot -f
        ;;
    update)
        cd /opt/telegram-bot
        git pull
        systemctl restart telegram-bot
        echo "âœ… Ð‘Ð¾Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
        ;;
    config)
        nano /opt/telegram-bot/.env
        ;;
    *)
        echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: $0 {start|stop|restart|status|logs|update|config}"
        exit 1
        ;;
esac
EOF

chmod +x /usr/local/bin/telegram-bot

echo ""
echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
echo ""
echo "ðŸ“ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "1. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ: telegram-bot config"
echo "2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð±Ð¾Ñ‚Ð°: telegram-bot start"
echo "3. Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº: systemctl enable telegram-bot"
echo "4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑ: telegram-bot status"
echo ""
echo "ðŸ”§ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "  telegram-bot start    - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°"
echo "  telegram-bot stop     - ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°"
echo "  telegram-bot restart  - ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°"
echo "  telegram-bot status   - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ"
echo "  telegram-bot logs     - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸"
echo "  telegram-bot update   - ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°"
echo "  telegram-bot config   - Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ"
echo ""
echo "ðŸ“– Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: https://github.com/vokin23/SearchTelegramChannel"
